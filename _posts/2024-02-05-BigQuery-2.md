---
layout: post
title: BigQuery ì¿¼ë¦¬ í•„ìˆ˜ ìš”ì†Œ (ì •ë¦¬ì¤‘)
subtitle: ë„ì„œ êµ¬ê¸€ ë¹…ì¿¼ë¦¬ ì™„ë²½ ê°€ì´ë“œ ìŠ¤í„°ë””
author: san9hyun
categories: BigQuery
banner : /assets/images/banners/squirrel.jpg
tags: BigQuery ë¹…ì¿¼ë¦¬
---


> ğŸ§‘ ë„ì„œ [ë°œë¦¬ì•„íŒŒ ë½ì‰¬ë§ˆë‚œ,ì¡°ë˜ í‹°ê°€ë‹ˆ "êµ¬ê¸€ ë¹…ì¿¼ë¦¬ ì™„ë²½ ê°€ì´ë“œ" Oâ€™Reilly]ë¥¼ ê°œì¸ì ìœ¼ë¡œ ê³µë¶€í•œ ê²ƒì…ë‹ˆë‹¤.

## ì¿¼ë¦¬ í•„ìˆ˜ ìš”ì†Œ ì •ë¦¬

### 1.WITH ì ˆ 

> â›³ï¸ ë¹…ì¿¼ë¦¬ì—ì„œ WITH êµ¬ë¬¸ì€ ì„ì‹œ í…Œì´ë¸”ì„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤!

```
SELECT * FROM (
  SELECT
    gender, tripduration / 60 AS minutes
  FROM
    `bigquery-public-data`.new_york_citibike.citibike_trips
)

WHERE minutes < 10 -- ë°”ê¹¥ìª½ì˜ SELECTëŠ” ì•ˆìª½ì˜ ì„œë¸Œ ì¿¼ë¦¬ì˜ ê²°ê³¼ë¥¼ ì°¸ì¡°í•˜ê¸° ë•Œë¬¸ì—, ì„œë¸Œì¿¼ë¦¬ê°€ ì‚¬ìš©í•œ ë³„ì¹­ì„ WHEREì ˆì—ë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.
LIMIT 5   
```

ìœ„ì™€ ê°™ì€ ì„œë¸Œì¿¼ë¦¬ ëŒ€ì‹  WITHì ˆì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. <br>
WITHì ˆì„ ì‚¬ìš©í•˜ë©´ ê°€ë…ì„±ì´ ë†’ì•„ì§€ê³ , ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤.<br>

```
WITH all_trips AS (
  SELECT
    gender, tripduration / 60 AS minutes
  FROM
    `bigquery-public-data`.new_york_citibike.citibike_trips
)

SELECT * FROM all_trips
WHERE minutes < 10 
LIMIT 5   
```

ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë§ì€ DBë“¤ì´ ìœ„ì™€ ê°™ì€ WITH êµ¬ë¬¸ì„ ì§€ì›í•œë‹¤.
ê·¸ëŸ°ë° WITH êµ¬ë¬¸ëŠ” ê°€ìƒì˜ í…Œì´ë¸”ì„ ìƒì„±í•˜ì—¬ ë©”ëª¨ë¦¬ì— í• ë‹¹í•˜ê¸° ë–„ë¬¸ì— ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí• ìˆ˜ë„ ìˆë‹¤.

í•˜ì§€ë§Œ, 
ë¹…ì¿¼ë¦¬ì—ì„œ WITH êµ¬ë¬¸ì€ ì´ë¦„ì´ ìˆëŠ” ì„œë¸Œì¿¼ë¦¬ ì²˜ëŸ¼ ì‘ë™í•˜ë©° ì„ì‹œ í…Œì´ë¸”ì„ ìƒì„±í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—(p62)<br>
ì„±ëŠ¥ì´ìŠˆë¥¼ í¬ê²Œ ê±±ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤ê³  í•œë‹¤.

### ORDER BY, GROUP BY

> â›³ï¸ ORDER BYëŠ” SELECTì ˆì´ ì‹¤í–‰ëœ ì´í›„ì— ì‹¤í–‰ ë˜ë¯€ë¡œ ë³„ì¹­ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.<br>
> â›³ï¸ GROUP BYëŠ” ì§‘ê³„í• ë•Œ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©

```
SELECT
  gender, AVG(tripduration / 60) AS avg_trip_duration
FROM
  `bigquery-public-data`.new_york_citibike.citibike_trips
WHERE
  tripduration is not NULL
GROUP BY
  gender
ORDER BY
  avg_trip_duration
```

ë‚¨ë…€ í‰ê·  tripdurationì„ êµ¬í• ë•Œ, ê°ê° ì§‘ê³„í•˜ë©´ ë°ì´í„°ì…‹ì— 2ë²ˆ ì ‘ê·¼í•˜ë©´ì„œ ê·¸ë§Œí¼ ë¹„ìš©ì„ ë‚­ë¹„í•œë‹¤.
ì´ë•Œ ìœ„ì™€ ê°™ì´ GROUP BY ì ˆì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

### HAVING
> â›³ï¸ HAVING ì ˆì„ ì‚¬ìš©í•˜ë©´ ê·¸ë£¹í™” ì—°ì‚° ì´í›„ì— í•„í„°ë§ì„ í•  ìˆ˜ ìˆë‹¤.

```
SELECT
  gender, AVG(tripduration / 60) AS avg_trip_duration
FROM
  `bigquery-public-data`.new_york_citibike.citibike_trips
WHERE
  tripduration is not NULL
GROUP BY
  gender
HAVING 
  avg_trip_duration > 14
ORDER BY
  avg_trip_duration
```
WHERE ì ˆì—ì„œëŠ” ë‹¹ì—°íˆ avg_trip_durationì— ëŒ€í•œ í•„í„°ë§ì„ í•  ìˆ˜ ì—†ë‹¤.

### ARRAY_AGGë¡œ ë±Œì—´ ë§Œë“¤ê¸°
> â›³ï¸ ARRAY_AGGë¥¼ ì‚¬ìš©í•˜ë©´ ìˆœì„œê°€ ìˆëŠ” ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” ARRAYë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

```
SELECT 
  gender
  ,ARRAY_AGG(numtrips order by year) AS numtrips
FROM (
  SELECT
    gender
    , EXTRACT(YEAR FROM starttime) AS year
    , COUNT(*) AS numtrips
  FROM
    `bigquery-public-data`.new_york_citibike.citibike_trips
  WHERE
    gender != 'unknown' AND starttime IS NOT NULL
  GROUP BY
    gender, year
  HAVING year > 2016
)
GROUP BY
  gender
```
ìœ„ ì¿¼ë¦¬ëŠ” ì„±ë³„ì— ë”°ë¥¸ ëŒ€ì—¬ íšŸìˆ˜ë¥¼ ì—°ë„ë³„ë¡œ ì •ë ¬í•œ ARRAYë¥¼ ì–»ê¸° ìœ„í•œ ì¿¼ë¦¬ë‹¤. 
ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ë‹¤. <br>
numtrips ì»¬ëŸ¼ì´ ë°°ì—´ë¡œ ë“¤ì–´ê°€ ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

![arr](/assets/images/contents/ë¹…ì¿¼ë¦¬/2ì¥/arr_agg.png)

ìœ„ í…Œì´ë¸”ì„ jsonìœ¼ë¡œ ë³€í™˜í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

```
[{
  "gender": "male",
  "numtrips": ["9306602", "3955871"]
}, {
  "gender": "female",
  "numtrips": ["3236735", "1260893"]
}]
```

### êµ¬ì¡°ì²´ì˜ ë°°ì—´(STRUCT)
> â›³ï¸ êµ¬ì¡°ì²´ëŠ” ìˆœì„œë¥¼ ê°–ëŠ” í•„ë“œì˜ ê·¸ë£¹ì´ë‹¤.

```
SELECT
  [
    STRUCT('male' AS gender,[930, 395] AS numtrips)
    ,STRUCT('female' AS gender, [323,126] AS numtrips)
  ] AS bikerides
```

ì´ ì¿¼ë¦¬ì˜ ì‹¤í–‰ ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ë‹¤. ìœ„ ARRAY_AGGì™€ í–‰ì˜ í‘œí˜„ì´ ì¡°ê¸ˆ ë‹¤ë¥´ë‹¤.<br>
ìœ„ ì»¤ë¦¬ì—ì„œ SELECT ì ˆì€ ë°°ì—´ì„ í¬í•¨í•˜ëŠ” í–‰ 1ê°œë§Œì„ ë°˜í™˜í•˜ë¯€ë¡œ, ë‘ ì„±ë³„ ë°ì´í„°ê°€ í•˜ë‚˜ì˜ í–‰ì— ë°˜í™˜ëœë‹¤.


![struct](/assets/images/contents/ë¹…ì¿¼ë¦¬/2ì¥/struct.png)

jsonìœ¼ë¡œ ë³€í™˜í•œ ê²°ê³¼ë„, êµ¬ì¡°ì²´ì˜ ì´ë¦„(bikerides)ì´ ì§€ì •ëœ ê²ƒ ë¹¼ê³ ëŠ” ë™ì¼í•œ í˜•íƒœë¡œ ì¶œë ¥ëœë‹¤.

```
[{
  "bikerides": [{
    "gender": "male",
    "numtrips": ["930", "395"]
  }, {
    "gender": "female",
    "numtrips": ["323", "126"]
  }]
}]
```

### ë°°ì—´ í’€ê¸°(UNNEST)
> â›³ï¸ UNNESTëŠ” ë°°ì—´ì˜ ìš”ì†Œë¥¼ í–‰ìœ¼ë¡œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ë‹¤.

```
SELECT * FROM UNNEST(
  [
    STRUCT('male' AS gender,[930, 395] AS numtrips)
    ,STRUCT('female' AS gender, [323,126] AS numtrips)
  ])
```
ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

![unnest](/assets/images/contents/ë¹…ì¿¼ë¦¬/2ì¥/unnest.png)

```
[{
  "gender": "male",
  "numtrips": ["930", "395"]
}, {
  "gender": "female",
  "numtrips": ["323", "126"]
}]
```

### íŠœí”Œ
> â›³ï¸ STRUCT í‚¤ì›Œë“œì™€ í•„ë“œ ì´ë¦„ì„ ìƒëµí•˜ë©´ íŠœí”Œ ë˜ëŠ” ìµëª… êµ¬ì¡°ì²´ê°€ ìƒì„±ëœë‹¤.<br>
> â›³ï¸ ë¹…ì¿¼ë¦¬ëŠ” ì¿¼ë¦¬ ê²°ê³¼ì—ì„œ ì´ë¦„ì´ ì§€ì •ë˜ì§€ ì•Šì€ ì»¬ëŸ¼ ë° êµ¬ì¡°ì²´ í•„ë“œì— ì„ì˜ì˜ ì´ë¦„ì„ í• ë‹¹í•œë‹¤.

```
SELECT
  [
    STRUCT('male',[930, 395])
    ,STRUCT('female', [323,126])
  ] 
```
ì´ ì¿¼ë¦¬ì˜ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

![tuple](/assets/images/contents/ë¹…ì¿¼ë¦¬/2ì¥/tuple.png)

```
[{
  "f0_": [{
    "_field_1": "male",
    "_field_2": ["930", "395"]
  }, {
    "_field_1": "female",
    "_field_2": ["323", "126"]
  }]
}]
```
ì»¬ëŸ¼ ì´ë¦„ì˜ ë±”ì¹­ì„ ìƒëµí•˜ë©´ ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ì´í•´í•˜ê¸° í˜ë“¤ê³  ìœ ì§€ë³´ìˆ˜ë„ ì–´ë ¤ì›Œì§„ë‹¤.
ì¼íšŒì„± ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ë©´ ë°˜ë“œì‹œ ì»¬ëŸ¼ ì´ë¦„ì„ ì‚¬ìš©í•œë‹¤.

### ë°°ì—´ í™œìš©í•˜ê¸°

> â›³ï¸ ë°°ì—´ì˜ ê¸¸ì´ ì¸¡ì •, ë°°ì—´ ë‚´ì˜ ê°œë³„ ìš”ì†Œ íƒìƒ‰ ë“±ì„ í•  ìˆ˜ ìˆë‹¤.

```
SELECT
  ARRAY_LENGTH(bikerides) AS num_items # ì¶œë ¥ ê²°ê³¼ : 2
  ,bikerides[OFFSET(0)].gender AS first_gender # ì¶œë ¥ ê²°ê³¼ : male
FROM
  (SELECT
    [
      STRUCT('male' AS gender,[930, 395] AS numtrips)
      ,STRUCT('female' AS gender, [323,126] AS numtrips)
    ] AS bikerides)
```


